<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>LayerZero 批量查询</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    textarea { width: 100%; height: 120px; }
    button { margin: 10px 0; padding: 10px 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    td, th { border: 1px solid #ddd; padding: 8px; text-align: center; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    input[type="checkbox"] { transform: scale(1.2); }
    .loading { animation: blink 1s linear infinite; color: #888; }
    @keyframes blink {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }
  </style>
</head>
<body>
  <h2>LayerZero 批量交易查询</h2>
  <p>每行输入一个钱包地址：</p>
  <textarea id="addresses"></textarea>
  <br>
  <button onclick="query()">查询</button>
  <button onclick="query(true)">只查勾选</button>
  <p style="font-size: 14px; color: gray;">默认查询 2024-09-21 之后数据</p>
  <div id="results"></div>

  <script>
    const MIN_TIMESTAMP = Math.floor(new Date("2024-09-21").getTime() / 1000);
    const API_BASE = "https://layer-zero-8po0p25nb-7ccccc21xs-projects.vercel.app/api/proxy?address=";
    const STORAGE_KEY = "layerzero_result_cache";

    function getDateKey(timestamp) {
      return new Date(timestamp * 1000).toISOString().split("T")[0];
    }

    function getWeekKey(timestamp) {
      const date = new Date(timestamp * 1000);
      const firstDay = new Date(date.getFullYear(), 0, 1);
      const dayOfYear = Math.floor((date - firstDay) / (24 * 60 * 60 * 1000));
      return `${date.getFullYear()}-W${Math.ceil((dayOfYear + firstDay.getDay() + 1) / 7)}`;
    }

    function getMonthKey(timestamp) {
      const date = new Date(timestamp * 1000);
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    }

    function timeAgo(timestamp) {
      const now = Date.now();
      const diff = Math.floor((now - timestamp * 1000) / (1000 * 60 * 60 * 24));
      return diff === 0 ? '今天' : `${diff}天前`;
    }

    async function fetchWithRetry(url, retries = 1) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`状态码 ${res.status}`);
        return await res.json();
      } catch (err) {
        if (retries > 0) {
          await new Promise(r => setTimeout(r, 30000));
          return fetchWithRetry(url, retries - 1);
        } else {
          throw err;
        }
      }
    }

    function saveCache(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadCache() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      } catch {
        return [];
      }
    }

    function renderTable(data) {
      const table = document.createElement("table");
      table.innerHTML = `<tr>
        <th>#</th>
        <th><input type="checkbox" id="selectAll" onchange="toggleAll(this)"></th>
        <th>地址</th>
        <th>交易数</th>
        <th>最后活跃</th>
        <th>日</th>
        <th>周</th>
        <th>月</th>
      </tr>`;

      data.forEach((row, index) => {
        const tr = document.createElement("tr");
        const url = `https://layerzeroscan.com/address/${row.address}`;
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td><input type="checkbox" class="row-check"></td>
          <td><a href="${url}" target="_blank">${row.address}</a></td>
          <td>${row.count}</td>
          <td>${row.lastActive}</td>
          <td>${row.day}</td>
          <td>${row.week}</td>
          <td>${row.month}</td>
        `;
        table.appendChild(tr);
      });

      const container = document.getElementById("results");
      container.innerHTML = '';
      container.appendChild(table);
    }

    function toggleAll(checkbox) {
      document.querySelectorAll('.row-check').forEach(c => c.checked = checkbox.checked);
    }

    async function query(onlyChecked = false) {
      const input = document.getElementById("addresses").value.trim();
      const addresses = input.split('\n').map(a => a.trim()).filter(Boolean);
      const container = document.getElementById("results");

      if (!addresses.length) {
        container.innerHTML = '<p style="color:red;">请输入地址</p>';
        return;
      }

      let table = document.createElement("table");
      table.innerHTML = `<tr>
        <th>#</th>
        <th><input type="checkbox" id="selectAll" onchange="toggleAll(this)"></th>
        <th>地址</th>
        <th>交易数</th>
        <th>最后活跃</th>
        <th>日</th>
        <th>周</th>
        <th>月</th>
      </tr>`;
      container.innerHTML = '';
      container.appendChild(table);

      const results = [];

      for (let i = 0; i < addresses.length; i++) {
        const addr = addresses[i];

        if (onlyChecked) {
          const rows = document.querySelectorAll("table tr");
          if (rows[i + 1] && !rows[i + 1].querySelector(".row-check")?.checked) continue;
        }

        const row = document.createElement("tr");
        row.innerHTML = `<td>${i + 1}</td><td><input type="checkbox" class="row-check"></td><td colspan="6" class="loading">${addr} 加载中...</td>`;
        table.appendChild(row);

        try {
          const json = await fetchWithRetry(`${API_BASE}${addr}`, 1);
          const messages = (json.result?.data?.messages || []).filter(m => m.created >= MIN_TIMESTAMP);
          const count = messages.length;
          const lastActive = messages.length ? timeAgo(messages[0].created) : "-";
          const day = new Set(messages.map(m => getDateKey(m.created))).size;
          const week = new Set(messages.map(m => getWeekKey(m.created))).size;
          const month = new Set(messages.map(m => getMonthKey(m.created))).size;

          results.push({ address: addr, count, lastActive, day, week, month });

          row.innerHTML = `
            <td>${i + 1}</td>
            <td><input type="checkbox" class="row-check"></td>
            <td><a href="https://layerzeroscan.com/address/${addr}" target="_blank">${addr}</a></td>
            <td>${count}</td>
            <td>${lastActive}</td>
            <td>${day}</td>
            <td>${week}</td>
            <td>${month}</td>
          `;
        } catch {
          row.innerHTML = `
            <td>${i + 1}</td>
            <td><input type="checkbox" class="row-check"></td>
            <td>${addr}</td>
            <td colspan="5" style="color:red;">查询失败</td>`;
        }
      }

      saveCache(results);
    }

    // 页面加载自动加载缓存数据
    window.onload = function () {
      const cached = loadCache();
      if (cached.length) {
        renderTable(cached);
      }
    };
  </script>
</body>
</html>
