<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>LayerZero 批量查询</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    textarea { width: 100%; height: 120px; }
    button { margin: 10px 0; padding: 10px 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    td, th { border: 1px solid #ddd; padding: 8px; text-align: center; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    input[type="checkbox"] { transform: scale(1.2); }
  </style>
</head>
<body>
  <h2>LayerZero 批量交易查询</h2>
  <p>每行输入一个钱包地址：</p>
  <textarea id="addresses"></textarea>
  <br>
  <button onclick="query()">查询</button>

  <div id="results"></div>

  <script>
    const MIN_TIMESTAMP = Math.floor(new Date("2024-10-21").getTime() / 1000);
    const API_BASE = "https://layer-zero-8po0p25nb-7ccccc21xs-projects.vercel.app/api/proxy?address=";

    function getDateKey(timestamp) {
      const date = new Date(timestamp * 1000);
      return date.toISOString().split("T")[0];
    }

    function getWeekKey(timestamp) {
      const date = new Date(timestamp * 1000);
      const firstDay = new Date(date.getFullYear(), 0, 1);
      const dayOfYear = Math.floor((date - firstDay) / (24 * 60 * 60 * 1000));
      return `${date.getFullYear()}-W${Math.ceil((dayOfYear + firstDay.getDay() + 1) / 7)}`;
    }

    function getMonthKey(timestamp) {
      const date = new Date(timestamp * 1000);
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    }

    function timeAgo(timestamp) {
      const now = Date.now();
      const diff = Math.floor((now - timestamp * 1000) / (1000 * 60 * 60 * 24));
      return diff === 0 ? '今天' : `${diff}天前`;
    }

    async function fetchWithRetry(url, retries = 1) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`状态码 ${res.status}`);
        return await res.json();
      } catch (err) {
        if (retries > 0) {
          console.warn(`请求失败，准备重试...`);
          await new Promise(resolve => setTimeout(resolve, 30000)); // 等待 30 秒
          return fetchWithRetry(url, retries - 1);
        } else {
          throw err;
        }
      }
    }

    async function query() {
      const addresses = document.getElementById('addresses').value.trim().split('\n').map(a => a.trim()).filter(Boolean);
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      const table = document.createElement('table');
      table.innerHTML = `<tr><th>#</th><th>选中</th><th>地址</th><th>交易数</th><th>最后活跃</th><th>日活</th><th>周活</th><th>月活</th></tr>`;
      resultsDiv.appendChild(table);

      for (let i = 0; i < addresses.length; i++) {
        const addr = addresses[i];
        const row = document.createElement('tr');
        row.innerHTML = `<td>${i + 1}</td><td><input type="checkbox" checked></td><td colspan="6">加载中：${addr}</td>`;
        table.appendChild(row);

        try {
          const json = await fetchWithRetry(`${API_BASE}${addr}`, 1);
          const messages = (json.result?.data?.messages || []).filter(m => m.created >= MIN_TIMESTAMP);

          const count = messages.length;
          const lastActive = messages.length > 0 ? timeAgo(messages[0].created) : '-';
          const daySet = new Set(messages.map(m => getDateKey(m.created)));
          const weekSet = new Set(messages.map(m => getWeekKey(m.created)));
          const monthSet = new Set(messages.map(m => getMonthKey(m.created)));

          row.innerHTML = `
            <td>${i + 1}</td>
            <td><input type="checkbox" checked></td>
            <td>${addr}</td>
            <td>${count}</td>
            <td>${lastActive}</td>
            <td>${daySet.size}</td>
            <td>${weekSet.size}</td>
            <td>${monthSet.size}</td>
          `;
        } catch (err) {
          row.innerHTML = `
            <td>${i + 1}</td>
            <td><input type="checkbox"></td>
            <td>${addr}</td>
            <td colspan="5" style="color:red;">查询失败，跳过</td>
          `;
        }
      }
    }
  </script>
</body>
</html>
