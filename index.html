<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>LayerZero 批量查询</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    textarea { width: 100%; height: 120px; }
    button { margin: 10px 10px 10px 0; padding: 10px 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    td, th { border: 1px solid #ddd; padding: 8px; text-align: center; cursor: default; }
    th.sortable:hover { background: #eee; cursor: pointer; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    input[type="checkbox"] { transform: scale(1.2); }
    #progress { margin-top: 10px; height: 16px; background: #f3f3f3; border: 1px solid #ccc; }
    #bar { height: 100%; width: 0%; background: #4caf50; text-align: center; color: white; font-size: 12px; }
    .loading { color: #888; animation: fade 1s infinite; }
    @keyframes fade {
      0% { opacity: 0.2; }
      50% { opacity: 1; }
      100% { opacity: 0.2; }
    }
  </style>
</head>
<body>
  <h2>LayerZero 批量交易查询</h2>
  <p>每行输入一个钱包地址：</p>
  <textarea id="addresses"></textarea>
  <br>
  起始时间（默认2024-09-21）：<input type="date" id="startDate" value="2024-09-21" />
  <br><br>
  <button onclick="query()">查询所有</button>
  <button onclick="query(true)">仅查询选中地址</button>
  <button onclick="clearAll()">清空所有数据</button>
  <div id="progress"><div id="bar">0%</div></div>
  <div id="results"></div>

  <script>
    const API_BASE = "https://layer-zero-8po0p25nb-7ccccc21xs-projects.vercel.app/api/proxy?address=";
    let originalData = [];

    function getDateKey(ts) {
      return new Date(ts * 1000).toISOString().split("T")[0];
    }

    function getWeekKey(ts) {
      const d = new Date(ts * 1000), f = new Date(d.getFullYear(), 0, 1);
      const day = Math.floor((d - f) / 86400000);
      return `${d.getFullYear()}-W${Math.ceil((day + f.getDay() + 1) / 7)}`;
    }

    function getMonthKey(ts) {
      const d = new Date(ts * 1000);
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    }

    function timeAgo(ts) {
      const days = Math.floor((Date.now() - ts * 1000) / (1000 * 60 * 60 * 24));
      return days === 0 ? '今天' : `${days}天前`;
    }

    async function fetchWithRetry(url, retries = 1) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`状态码 ${res.status}`);
        return await res.json();
      } catch (e) {
        if (retries > 0) {
          await new Promise(r => setTimeout(r, 30000));
          return fetchWithRetry(url, retries - 1);
        } else {
          throw e;
        }
      }
    }

 async function query(onlySelected = false) {
  const start = document.getElementById('startDate').value || "2024-09-21";
  const MIN_TIMESTAMP = Math.floor(new Date(start).getTime() / 1000);
  const inputAddresses = document.getElementById('addresses').value.trim().split('\n').map(a => a.trim()).filter(Boolean);
  localStorage.setItem('lz_addresses', inputAddresses.join('\n'));
  localStorage.setItem('lz_startDate', start);

  let addresses, rowsToUpdate = [];
  if (onlySelected) {
    // 保留页面已有表格，只更新勾选的行
    rowsToUpdate = originalData.filter(row => {
      const cb = row.row.querySelector("input[type=checkbox]");
      return cb && cb.checked;
    });
    addresses = rowsToUpdate.map(r => r.address);
  } else {
    // 全部重新查询并构建表格
    addresses = inputAddresses;
    originalData = [];
    document.getElementById('results').innerHTML = '';
    const table = document.createElement('table');
    table.innerHTML = `<thead><tr>
      <th>#</th>
      <th><input type="checkbox" id="selectAll" onchange="toggleAll(this)"></th>
      <th>地址</th>
      <th class="sortable" onclick="sortTable('count')">交易数</th>
      <th class="sortable" onclick="sortTable('last')">最后活跃</th>
      <th class="sortable" onclick="sortTable('day')">日</th>
      <th class="sortable" onclick="sortTable('week')">周</th>
      <th class="sortable" onclick="sortTable('month')">月</th>
    </tr></thead><tbody id="tbody"></tbody>`;
    document.getElementById('results').appendChild(table);
    rowsToUpdate = addresses.map((addr, i) => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${i + 1}</td><td><input type="checkbox"></td><td colspan="6" class="loading">加载中：${addr}</td>`;
      table.querySelector("tbody").appendChild(row);
      return { address: addr, row, index: i + 1 };
    });
  }

  for (let i = 0; i < rowsToUpdate.length; i++) {
    const { address: addr, row, index } = rowsToUpdate[i];
    row.innerHTML = `<td>${index}</td><td><input type="checkbox" checked></td><td colspan="6" class="loading">加载中：${addr}</td>`;

    try {
      const json = await fetchWithRetry(`${API_BASE}${addr}`, 1);
      const messages = (json.result?.data?.messages || []).filter(m => m.created >= MIN_TIMESTAMP);
      const count = messages.length;
      const lastActive = count > 0 ? timeAgo(messages[0].created) : '-';
      const daySet = new Set(messages.map(m => getDateKey(m.created)));
      const weekSet = new Set(messages.map(m => getWeekKey(m.created)));
      const monthSet = new Set(messages.map(m => getMonthKey(m.created)));

      row.innerHTML = `
        <td>${index}</td>
        <td><input type="checkbox" checked></td>
        <td><a href="https://layerzeroscan.com/address/${addr}" target="_blank">${addr}</a></td>
        <td>${count}</td>
        <td>${lastActive}</td>
        <td>${daySet.size}</td>
        <td>${weekSet.size}</td>
        <td>${monthSet.size}</td>
      `;

      let target = originalData.find(d => d.address === addr);
      if (!target) {
        target = { address: addr };
        originalData.push(target);
      }
      Object.assign(target, {
        index,
        checked: true,
        count,
        last: lastActive === '-' ? 9999 : parseInt(lastActive),
        day: daySet.size,
        week: weekSet.size,
        month: monthSet.size,
        row
      });

    } catch (e) {
      row.innerHTML = `<td>${index}</td><td><input type="checkbox"></td><td>${addr}</td><td colspan="5" style="color:red;">查询失败</td>`;
    }

    updateProgress(i + 1, rowsToUpdate.length);
  }

  saveDataToCache();
}


    function toggleAll(box) {
      document.querySelectorAll("tbody input[type='checkbox']").forEach(cb => cb.checked = box.checked);
      originalData.forEach(d => d.checked = box.checked);
    }

    function updateProgress(done, total) {
      const bar = document.getElementById('bar');
      const percent = Math.round((done / total) * 100);
      bar.style.width = percent + '%';
      bar.textContent = `${done}/${total} (${percent}%)`;
    }

    function sortTable(field) {
      const tbody = document.querySelector("#tbody");
      const rows = Array.from(originalData);
      const asc = !sortTable.last || sortTable.last.field !== field || !sortTable.last.asc;
      sortTable.last = { field, asc };

      rows.sort((a, b) => (asc ? a[field] - b[field] : b[field] - a[field]));
      rows.forEach((d, i) => tbody.appendChild(d.row));
    }

    function saveDataToCache() {
      const dataToSave = originalData.map(d => ({
        ...d,
        checked: d.row.querySelector("input[type=checkbox]").checked
      }));
      localStorage.setItem('lz_data', JSON.stringify(dataToSave));
    }

    function restoreFromCache() {
      const cached = localStorage.getItem('lz_data');
      if (!cached) return;

      const restored = JSON.parse(cached);
      const resultsDiv = document.getElementById('results');
      const table = document.createElement('table');
      table.innerHTML = `<thead><tr>
        <th>#</th><th><input type="checkbox" id="selectAll" onchange="toggleAll(this)"></th>
        <th>地址</th><th class="sortable" onclick="sortTable('count')">交易数</th>
        <th class="sortable" onclick="sortTable('last')">最后活跃</th>
        <th class="sortable" onclick="sortTable('day')">日</th>
        <th class="sortable" onclick="sortTable('week')">周</th>
        <th class="sortable" onclick="sortTable('month')">月</th>
      </tr></thead><tbody id="tbody"></tbody>`;
      resultsDiv.appendChild(table);
      const tbody = table.querySelector("tbody");

      originalData = restored.map((d, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${i + 1}</td>
          <td><input type="checkbox" ${d.checked ? "checked" : ""}></td>
          <td><a href="https://layerzeroscan.com/address/${d.address}" target="_blank">${d.address}</a></td>
          <td>${d.count}</td>
          <td>${d.last === 9999 ? '-' : `${d.last}天前`}</td>
          <td>${d.day}</td>
          <td>${d.week}</td>
          <td>${d.month}</td>
        `;
        row.querySelector("input[type=checkbox]").addEventListener("change", () => {
          d.checked = row.querySelector("input[type=checkbox]").checked;
        });
        tbody.appendChild(row);
        return { ...d, row };
      });
    }

    function clearAll() {
      localStorage.clear();
      document.getElementById('addresses').value = '';
      document.getElementById('results').innerHTML = '';
      updateProgress(0, 1);
    }

    window.onload = () => {
      const saved = localStorage.getItem('lz_addresses');
      const start = localStorage.getItem('lz_startDate');
      if (saved) document.getElementById('addresses').value = saved;
      if (start) document.getElementById('startDate').value = start;
      restoreFromCache();
    };
  </script>
</body>
</html>
