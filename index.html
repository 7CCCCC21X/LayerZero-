<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>LayerZero 批量查询</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    textarea { width: 100%; height: 120px; }
    button { margin: 10px 0; padding: 10px 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    td, th { border: 1px solid #ddd; padding: 8px; text-align: center; }
    tr:nth-child(even) { background-color: #f9f9f9; }
  </style>
</head>
<body>
  <h2>LayerZero 批量交易查询</h2>
  <p>每行输入一个钱包地址：</p>
  <textarea id="addresses"></textarea>
  <br>
  <button onclick="query()">查询</button>

  <div id="results"></div>

  <script>
    const MIN_TIMESTAMP = Math.floor(new Date("2024-10-21").getTime() / 1000);

    function getDateKey(timestamp) {
      const date = new Date(timestamp * 1000);
      return date.toISOString().split("T")[0]; // yyyy-mm-dd
    }

    function getWeekKey(timestamp) {
      const date = new Date(timestamp * 1000);
      const firstDay = new Date(date.getFullYear(), 0, 1);
      const dayOfYear = Math.floor((date - firstDay) / (24 * 60 * 60 * 1000));
      return `${date.getFullYear()}-W${Math.ceil((dayOfYear + firstDay.getDay() + 1) / 7)}`;
    }

    function getMonthKey(timestamp) {
      const date = new Date(timestamp * 1000);
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`; // yyyy-mm
    }

    async function query() {
      const addresses = document.getElementById('addresses').value.trim().split('\n').map(a => a.trim()).filter(Boolean);
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '查询中...';

      const table = document.createElement('table');
      table.innerHTML = `<tr><th>地址</th><th>交易数</th><th>最后活跃</th><th>日活</th><th>周活</th><th>月活</th></tr>`;

      for (const addr of addresses) {
        try {
          const res = await fetch(`https://layer-zero-8po0p25nb-7ccccc21xs-projects.vercel.app/api/proxy?address=${addr}`);
          const json = await res.json();
          const messages = (json.result?.data?.messages || []).filter(m => m.created >= MIN_TIMESTAMP);

          const count = messages.length;
          const lastActive = messages[0] ? new Date(messages[0].created * 1000).toLocaleString() : '-';

          const daySet = new Set(messages.map(m => getDateKey(m.created)));
          const weekSet = new Set(messages.map(m => getWeekKey(m.created)));
          const monthSet = new Set(messages.map(m => getMonthKey(m.created)));

          const row = document.createElement('tr');
          row.innerHTML = `<td>${addr}</td><td>${count}</td><td>${lastActive}</td><td>${daySet.size}</td><td>${weekSet.size}</td><td>${monthSet.size}</td>`;
          table.appendChild(row);
        } catch (err) {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${addr}</td><td colspan="5">查询失败</td>`;
          table.appendChild(row);
        }
      }

      resultsDiv.innerHTML = '';
      resultsDiv.appendChild(table);
    }
  </script>
</body>
</html>
