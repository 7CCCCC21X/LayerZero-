<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>LayerZero 批量查询</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    textarea { width: 100%; height: 120px; }
    button { margin: 10px 0; padding: 10px 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    td, th { border: 1px solid #ddd; padding: 8px; text-align: center; }
    tr:nth-child(even) { background-color: #f9f9f9; }
  </style>
</head>
<body>
  <h2>LayerZero 批量交易查询</h2>
  <p>每行输入一个钱包地址：</p>
  <textarea id="addresses"></textarea>
  <br>
  <button onclick="query()">查询</button>

  <div id="results"></div>

  <script>
    function getWeek(timestamp) {
      const date = new Date(timestamp * 1000);
      const onejan = new Date(date.getFullYear(), 0, 1);
      return `${date.getFullYear()} 第${Math.ceil((((date - onejan) / 86400000) + onejan.getDay() + 1) / 7)}周`;
    }

    async function query() {
      const addresses = document.getElementById('addresses').value.trim().split('\n').map(a => a.trim()).filter(Boolean);
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '查询中...';

      const table = document.createElement('table');
      table.innerHTML = `<tr><th>地址</th><th>交易数量</th><th>最后活跃</th><th>活跃周数</th></tr>`;

      for (const addr of addresses) {
        try {
          const res = await fetch(`https://layer-zero-8po0p25nb-7ccccc21xs-projects.vercel.app/api/proxy?address=${addr}`);
          const json = await res.json();
          const messages = json.result?.data?.messages || [];

          const count = messages.length;
          const weeks = new Set(messages.map(m => getWeek(m.created)));
          const lastActive = messages[0] ? new Date(messages[0].created * 1000).toLocaleString() : '-';

          const row = document.createElement('tr');
          row.innerHTML = `<td>${addr}</td><td>${count}</td><td>${lastActive}</td><td>${[...weeks].join(', ')}</td>`;
          table.appendChild(row);
        } catch (err) {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${addr}</td><td colspan="3">查询失败</td>`;
          table.appendChild(row);
        }
      }

      resultsDiv.innerHTML = '';
      resultsDiv.appendChild(table);
    }
  </script>
</body>
</html>
